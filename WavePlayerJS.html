<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WavePlayerJS</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f0f0f0;
    color: #333;
  }
  
  h1 { text-align: center; }
  
  input, textarea, button {
    font-size: 1rem;
    margin: 5px 0;
    width: 100%;
	box-sizing: border-box;
  }
  
  textarea { height: 80px; }
  label { font-weight: bold; }
  div { width: 100%; }
  
  button {
		border-radius: 10px;
		padding-top: 10px;
		padding-bottom: 10px;
		width: 120px;
  }
  
  .buttons{
		display: flex;
		flex-direction: row;
		justify-content: space-between;
		flex: 0 0 100%
  }
  
  .buttons .main-buttons{
		display: flex;
		flex: 4;
		gap: 0.5rem;
		flex-direction: row;
		justify-content: start;
  }
  
  .buttons .load-preset {
		display: flex;
		gap: 0;
		justify-content: end;
  }
  
  #dark-button {
		position: absolute;
		width: 120px;
		top: 41px;
		right: 28px;
  }
</style>
</head>
<body>
	<header>
		<div id="dark-button">
			<button onclick="switchTheme();" id="theme-button">Dark Mode</button>
		</div>
		<h1>WavePlayerJS</h1>
	</header>

	<label for="formula">Enter your waveform formula (use "t" as time in seconds):</label>
	<textarea id="formula">(2/Math.PI)*Math.asin(Math.sin(2*t*vf))*va + (2/Math.PI)*Math.tan(Math.sin(t*vf))*va*vp</textarea>

	<label for="vf">Frequency (vf, Hz):</label>
	<input type="number" id="vf" value="2000" step="1">

	<label for="va">Amplitude (va, 0-1):</label>
	<input type="number" id="va" value="0.5" step="0.1" min="0" max="1">

	<label for="vp">Parameter (vp):</label>
	<input type="number" id="vp" value="1" step="1">

	<div style="display: flex; margin-top: 8px">
	<div class="buttons">
		<div class="main-buttons">
			<button id="playBtn">Play Wave</button>
			<button id="stopBtn">Stop Wave</button>
		</div>
		<button id="loadPresetBtn" style="margin-left: auto;" onclick="alert('This feature hasn\'t been added yet.');">Load Preset</button>
	</div>
	</div>

	<br/>
	<p>Use ** instead of ^ for exponents</p>

<script>
let audioCtx;
let bufferSource;

var dark;
dark=0;

document.getElementById("playBtn").addEventListener("click", playWave);
document.getElementById("stopBtn").addEventListener("click", stopWave);

function playWave() {
  stopWave(); // Stop previous wave if any
  const formula = document.getElementById("formula").value;
  const vf = parseFloat(document.getElementById("vf").value);
  const va = parseFloat(document.getElementById("va").value);
  const vp = parseFloat(document.getElementById("vp").value);

  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const sampleRate = audioCtx.sampleRate;
  const duration = 2; // seconds
  const buffer = audioCtx.createBuffer(1, sampleRate * duration, sampleRate);
  const data = buffer.getChannelData(0);

  for (let i = 0; i < data.length; i++) {
    const t = i / sampleRate;
    try {
      // eslint-disable-next-line no-eval
      let y = eval(formula);
      // Clamp y to [-1, 1] to prevent clipping
      if (y > 1) y = 1;
      if (y < -1) y = -1;
      data[i] = y;
    } catch (e) {
      data[i] = 0;
    }
  }

  bufferSource = audioCtx.createBufferSource();
  bufferSource.buffer = buffer;
  bufferSource.connect(audioCtx.destination);
  bufferSource.start();
}

function stopWave() {
  if (bufferSource) {
    bufferSource.stop();
    bufferSource.disconnect();
  }
}

function switchTheme() {
	let themeBtn = document.getElementById("theme-button");
	let pagebody = document.body;
	let elements = document.querySelectorAll("button, input, textarea");
	
	if (dark==0) {
		// Switch to dark mode
		themeBtn.textContent = "Light Mode";
		pagebody.style.background = "#232323";
		pagebody.style.color = "#f0f0f0";
		for (let el of elements) {
        el.style.background = "#323232";
        el.style.color = "#f0f0f0";
    }
		dark = 1;
	} else if (dark==1) {
		// Switch to light mode
		themeBtn.textContent = "Dark Mode";
		pagebody.style.background = "#f0f0f0";
		pagebody.style.color = "#333";
		for (let el of elements) {
        el.style.background = "";
        el.style.color = "";
		}
		dark = 0;
	}
}
</script>
</body>
</html>
